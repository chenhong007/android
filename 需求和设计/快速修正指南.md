# 文档一致性快速修正指南

> **目的：** 快速修正文档中发现的术语和命名不一致问题  
> **预计时间：** 2小时  
> **优先级：** 🔴 高

---

## 🔴 必须立即修正的问题

### 1. UsageTracking → AppSession（全局替换）

**文件：** `需求和设计/技术说明_统计系统架构.md`

**查找并替换：**
```
UsageTracking → AppSession
UsageTrackingDao → AppSessionDao
usageTracking → appSession
insertUsages → insertSessions
```

**影响位置：**
- 第31行：`生成 UsageTracking 记录`
- 第40行：`insertUsages(List<UsageTracking>)`
- 第178行：`创建 UsageTracking 记录`
- 第189行：`usageRepository.insertUsages()`
- 第437行：`val record = AppSession`（✅ 已正确）
- 全文约20处需要修改

**修正示例：**
```markdown
# 修正前
→ 生成 UsageTracking 记录
→ usageRepository.insertUsages(usageRecords)

# 修正后
→ 生成 AppSession 记录
→ appSessionRepository.insertSessions(appSessions)
```

---

### 2. 统一SQL字段命名为蛇形（snake_case）

**文件：** `需求和设计/技术说明_统计系统架构.md`

**修正规则：**
- `sessionId` → `session_id`
- `packageName` → `package_name`
- `appName` → `app_name`
- `timestamp` → `start_time`（注意：这是开始时间）
- `endTimestamp` → `end_time`
- `eventType` → `event_type`
- `createdAt` → `created_at`

**需要修正的SQL代码块：**

#### 位置1：第475-488行（数据库表结构）
```sql
# 修正前
CREATE TABLE app_session (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    packageName TEXT NOT NULL,
    appName TEXT NOT NULL,
    sessionId TEXT NOT NULL,
    timestamp INTEGER NOT NULL,
    endTimestamp INTEGER NOT NULL,
    ...
);

# 修正后
CREATE TABLE app_session (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    package_name TEXT NOT NULL,
    app_name TEXT NOT NULL,
    session_id TEXT NOT NULL,
    start_time INTEGER NOT NULL,
    end_time INTEGER NOT NULL,
    ...
);
```

#### 位置2：第529-532行（查询1）
```sql
# 修正前
SELECT COALESCE(SUM(duration), 0) 
FROM app_session 
WHERE timestamp >= :startTime AND timestamp <= :endTime

# 修正后
SELECT COALESCE(SUM(duration), 0) 
FROM app_session 
WHERE start_time >= :startTime AND start_time <= :endTime
```

#### 位置3：第561-574行（查询2）
```sql
# 修正前
SELECT 
    packageName,
    appName,
    category,
    SUM(duration) as totalDuration,
    COUNT(*) as sessionCount,
    MAX(timestamp) as lastUsedTimestamp,
    0.0 as percentage
FROM app_session
WHERE timestamp >= :startTime AND timestamp <= :endTime
GROUP BY packageName
ORDER BY totalDuration DESC
LIMIT 5

# 修正后
SELECT 
    package_name,
    app_name,
    category,
    SUM(duration) AS total_duration,
    COUNT(*) AS session_count,
    MAX(start_time) AS last_used_timestamp,
    0.0 AS percentage
FROM app_session
WHERE start_time >= :startTime AND start_time <= :endTime
GROUP BY package_name
ORDER BY total_duration DESC
LIMIT 5
```

---

### 3. 统一 timestamp → start_time 术语（SQL字段）

**文件：** `需求和设计/技术说明_统计系统架构.md`

**修正位置：**
- 第481行：`timestamp INTEGER NOT NULL,    -- 开始时间`
- 第482行：`endTimestamp INTEGER NOT NULL, -- 结束时间`

**修正为：**
```sql
start_time INTEGER NOT NULL,    -- 开始时间（蛇形命名）
end_time INTEGER NOT NULL,      -- 结束时间（蛇形命名）
```

**注意：** 这是SQL字段的修正，Kotlin代码中仍使用`startTime`（驼峰）

**文档说明修正：**
在文档开头（第8行后）添加命名规范说明：
```markdown
## 📝 命名规范说明

### SQL表字段命名
- 使用**蛇形命名**（snake_case）
- 示例：`session_id`, `start_time`, `package_name`, `event_type`

### Kotlin实体类命名
- 使用**驼峰命名**（camelCase）
- 示例：`sessionId`, `startTime`, `packageName`, `eventType`

### 自动转换
- Room框架自动处理SQL字段与Kotlin属性的命名转换
- 无需在代码中手动处理

**示例对照：**
| SQL字段 | Kotlin属性 | 类型 |
|---------|-----------|------|
| `session_id` | `sessionId` | String |
| `start_time` | `startTime` | Long |
| `package_name` | `packageName` | String |
| `event_type` | `eventType` | ScreenEventType |
```

---

## 🟡 建议修正的问题

### 4. 统一"APP使用时长"术语

**影响文件：**
- `需求和设计/prd需求.md`
- `需求和设计/前端UI设计方案_v2.md`

**查找并替换：**
```
"应用使用时长" → "APP使用时长"
"应用时长" → "APP使用时长"
```

**保持一致的术语：**
- ✅ **APP使用时长**（标准术语，来自术语统一表）
- ❌ 应用使用时长
- ❌ 应用时长

---

### 5. 添加表字段注释

**文件：** `需求和设计/数据模型设计方案_v2.md`

**修正位置：** 第276-288行（daily_summary表）

**修正为：**
```sql
CREATE TABLE daily_summary (
    summary_id TEXT PRIMARY KEY,
    date TEXT UNIQUE NOT NULL,                        -- YYYY-MM-DD格式
    total_screen_time INTEGER NOT NULL DEFAULT 0,     -- 📱 今日屏幕时长（毫秒）
    phone_unlock_count INTEGER NOT NULL DEFAULT 0,    -- 🔓 手机解锁次数
    app_open_count INTEGER NOT NULL DEFAULT 0,        -- 📲 APP打开次数
    app_usage_duration INTEGER NOT NULL DEFAULT 0,    -- 🔆 APP使用时长（毫秒）
    goal_progress INTEGER DEFAULT 0,                  -- 目标完成度（百分比）
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000),
    updated_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);
```

---

## 🟢 可选优化

### 6. 统一文档版本号

**影响文件：** 所有文档

**修正操作：**
1. 确保所有文档标题包含版本号 `v2.1`
2. 更新文档开头的版本信息：
```markdown
> **版本：** v2.1  
> **更新日期：** 2025-10-15  
> **术语参考：** [术语统一表 v2.1](./术语统一表.md)
```

**检查清单：**
- [x] 术语统一表.md - ✅ v2.1
- [x] 数据模型设计方案_v2.md - ✅ v2.1
- [ ] 前端UI设计方案_v2.md - ⚠️ 标题显示v2，应为v2.1
- [x] 技术说明_统计系统架构.md - ✅ v2.1
- [x] 实现路线图_v2.md - ✅ v2.1
- [ ] prd需求.md - ❌ 无版本号，建议添加

---

## ✅ 验证步骤

完成修正后，执行以下验证：

### 1. 全文搜索验证
```bash
# 搜索旧术语（应该找不到）
grep -r "UsageTracking" 需求和设计/
grep -r "app_sessions" 需求和设计/  # 复数形式
grep -r "openCount" 需求和设计/    # 废弃字段

# 搜索混用的命名（在SQL代码中不应出现）
grep -r "sessionId TEXT" 需求和设计/  # 应该是 session_id
grep -r "packageName TEXT" 需求和设计/  # 应该是 package_name
```

### 2. 术语一致性检查
- [ ] 四大核心指标名称统一
- [ ] 类名统一为 AppSession
- [ ] SQL字段统一为蛇形命名
- [ ] Kotlin属性统一为驼峰命名
- [ ] 术语"APP使用时长"统一使用

### 3. 交叉引用验证
打开以下文档，验证核心概念是否一致：
1. 术语统一表 - 第12-17行（四大核心指标）
2. 数据模型设计 - 第276-288行（daily_summary表）
3. 技术说明 - 第68-71行（数据库字段定义）

---

## 📋 修正检查清单

### 高优先级修正
- [ ] UsageTracking → AppSession（约20处）
- [ ] SQL字段改为蛇形命名（约50处）
- [ ] timestamp → startTime 术语统一（约15处）
- [ ] 添加命名规范说明（1处）

### 中优先级修正
- [ ] "应用使用时长" → "APP使用时长"（约10处）
- [ ] 添加SQL字段注释（1处）

### 低优先级修正
- [ ] 统一文档版本号（6个文档）
- [ ] 添加版本历史章节

---

## 🚀 预计时间分配

| 任务 | 预计时间 | 难度 |
|------|---------|------|
| UsageTracking替换 | 20分钟 | 简单 |
| SQL字段命名修正 | 60分钟 | 中等 |
| 添加命名规范说明 | 15分钟 | 简单 |
| 术语统一修正 | 15分钟 | 简单 |
| 添加注释和优化 | 30分钟 | 简单 |
| **总计** | **2小时20分钟** | - |

---

## 📞 注意事项

1. **备份文档**：修改前备份所有文件
2. **逐项验证**：每完成一项检查清单，运行验证步骤
3. **代码同步**：文档修正后，同步更新实际代码
4. **团队通知**：修正完成后通知团队成员查看新规范

---

**修正指南版本：** v1.0  
**创建日期：** 2025-10-15  
**参考文档：** [文档一致性审查报告 v1.0](./文档一致性审查报告_v1.md)

