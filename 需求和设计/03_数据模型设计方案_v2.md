# æ•°æ®æ¨¡å‹è®¾è®¡æ–¹æ¡ˆ v2.2

> **ç‰ˆæœ¬ï¼š** v2.2  
> **æ›´æ–°æ—¥æœŸï¼š** 2025-10-15  
> **æ–‡æ¡£çŠ¶æ€ï¼š** æ–°å¢å¤šæ—¶é—´ç»´åº¦ç»Ÿè®¡æ”¯æŒï¼Œæ”¯æŒæ—¥/å‘¨/æœˆ/å¹´/è‡ªå®šä¹‰ç»´åº¦æŸ¥è¯¢  
> **æƒå¨æ¥æºï¼š** ä¸ã€Šæœ¯è¯­ç»Ÿä¸€è¡¨ v2.3ã€‹å®Œå…¨åŒæ­¥

---

## ğŸ¯ è®¾è®¡åŸåˆ™

1. **ç»Ÿä¸€æœ¯è¯­**ï¼šæ‰€æœ‰è¡¨åã€å­—æ®µåä¸¥æ ¼éµå¾ªã€Šæœ¯è¯­ç»Ÿä¸€è¡¨ v2.1ã€‹
2. **å•æ•°è¡¨å**ï¼šæ‰€æœ‰è¡¨åä½¿ç”¨å•æ•°å½¢å¼ï¼ˆå¦‚ `app_session` è€Œé `app_sessions`ï¼‰
3. **è¡Œä¸ºè®°å½•**ï¼šæ— è®ºä½¿ç”¨æ—¶é•¿å¤šçŸ­ï¼Œè¡Œä¸ºå¿…é¡»è®°å½•ï¼ˆä¿è¯ç»Ÿè®¡å‡†ç¡®ï¼‰
4. **æ—¶é•¿è¿‡æ»¤**ï¼šçŸ­æ—¶ä¼šè¯durationè®¾ä¸º0ï¼Œä½†è®°å½•ä¿ç•™ï¼ˆç”¨äºå‡†ç¡®è®¡æ•°ï¼‰
5. **ç‰ˆæœ¬åŒæ­¥**ï¼šä¸æœ¯è¯­è¡¨ã€æŠ€æœ¯æ¶æ„æ–‡æ¡£ä¿æŒå®Œå…¨ä¸€è‡´

---

## ğŸ—ï¸ æ•°æ®åº“æ¶æ„

### ERå›¾ï¼ˆå®ä½“å…³ç³»å›¾ï¼‰

```mermaid
erDiagram
    app_session ||--o{ app_usage_detail : contains
    app_session ||--o{ daily_summary : contributes_to
    app_session ||--o{ daily_app_summary : contributes_to
    screen_event ||--o{ daily_summary : contributes_to
    daily_summary ||--o{ weekly_summary : aggregates_to
    daily_summary ||--o{ monthly_summary : aggregates_to
    daily_summary ||--o{ yearly_summary : aggregates_to
    user_goal ||--o{ daily_summary : tracks_progress
    app_metadata ||--o{ app_session : references
    app_metadata ||--o{ daily_app_summary : references
    notification_event ||--o{ app_session : may_trigger
    
    app_session {
        string session_id PK "ä¼šè¯å”¯ä¸€ID"
        string package_name FK "åº”ç”¨åŒ…å"
        long start_time "å¼€å§‹æ—¶é—´"
        long end_time "ç»“æŸæ—¶é—´"
        long duration "ä½¿ç”¨æ—¶é•¿"
        int switch_count "åˆ‡æ¢æ¬¡æ•°"
        string category "åº”ç”¨åˆ†ç±»"
        string trigger_type "è§¦å‘æ–¹å¼"
        string exit_type "é€€å‡ºæ–¹å¼"
        string collection_mode "æ”¶é›†æ¨¡å¼"
        string device_state "è®¾å¤‡çŠ¶æ€"
    }
    
    app_usage_detail {
        string detail_id PK "æ˜ç»†ID"
        string session_id FK "ä¼šè¯ID"
        long timestamp "æ—¶é—´æˆ³"
        string state_type "çŠ¶æ€ç±»å‹"
    }
    
    screen_event {
        string event_id PK "äº‹ä»¶ID"
        string event_type "äº‹ä»¶ç±»å‹"
        long timestamp "æ—¶é—´æˆ³"
        long duration "äº‹ä»¶æŒç»­æ—¶é—´"
    }
    
    notification_event {
        string notification_id PK "é€šçŸ¥ID"
        string package_name "åº”ç”¨åŒ…å"
        string action "ç”¨æˆ·æ“ä½œ"
        long timestamp "æ—¶é—´æˆ³"
        boolean is_interactive "æ˜¯å¦äº¤äº’"
    }
    
    daily_summary {
        string summary_id PK "æ±‡æ€»ID"
        string date "æ—¥æœŸ"
        long total_screen_time "ä»Šæ—¥å±å¹•æ—¶é•¿"
        int phone_unlock_count "æ‰‹æœºè§£é”æ¬¡æ•°"
        int app_open_count "APPæ‰“å¼€æ¬¡æ•°"
        long app_usage_duration "APPä½¿ç”¨æ—¶é•¿"
        int goal_progress "ç›®æ ‡è¿›åº¦"
    }
    
    daily_app_summary {
        string summary_id PK "æ±‡æ€»ID"
        string date "æ—¥æœŸ"
        string package_name "åº”ç”¨åŒ…å"
        string app_name "åº”ç”¨åç§°"
        string category "åº”ç”¨åˆ†ç±»"
        int app_open_count "APPæ‰“å¼€æ¬¡æ•°"
        long app_usage_duration "APPä½¿ç”¨æ—¶é•¿"
    }
    
    weekly_summary {
        string summary_id PK "æ±‡æ€»ID"
        string week_key "å‘¨æ ‡è¯†"
        int year "å¹´ä»½"
        int week_number "å‘¨æ•°"
        string start_date "èµ·å§‹æ—¥æœŸ"
        string end_date "ç»“æŸæ—¥æœŸ"
        long total_screen_time "å‘¨å±å¹•æ—¶é•¿"
        int phone_unlock_count "å‘¨è§£é”æ¬¡æ•°"
        int app_open_count "å‘¨APPæ‰“å¼€æ¬¡æ•°"
        long app_usage_duration "å‘¨APPä½¿ç”¨æ—¶é•¿"
    }
    
    monthly_summary {
        string summary_id PK "æ±‡æ€»ID"
        string month_key "æœˆæ ‡è¯†"
        int year "å¹´ä»½"
        int month "æœˆä»½"
        long total_screen_time "æœˆå±å¹•æ—¶é•¿"
        int phone_unlock_count "æœˆè§£é”æ¬¡æ•°"
        int app_open_count "æœˆAPPæ‰“å¼€æ¬¡æ•°"
        long app_usage_duration "æœˆAPPä½¿ç”¨æ—¶é•¿"
    }
    
    yearly_summary {
        string summary_id PK "æ±‡æ€»ID"
        int year "å¹´ä»½"
        long total_screen_time "å¹´å±å¹•æ—¶é•¿"
        int phone_unlock_count "å¹´è§£é”æ¬¡æ•°"
        int app_open_count "å¹´APPæ‰“å¼€æ¬¡æ•°"
        long app_usage_duration "å¹´APPä½¿ç”¨æ—¶é•¿"
    }
    
    user_goal {
        string goal_id PK "ç›®æ ‡ID"
        string goal_type "ç›®æ ‡ç±»å‹"
        long target_value "ç›®æ ‡å€¼"
        long current_value "å½“å‰å€¼"
        string period "å‘¨æœŸ"
        boolean is_active "æ˜¯å¦æ¿€æ´»"
    }
    
    app_metadata {
        string package_name PK "åº”ç”¨åŒ…å"
        string app_name "åº”ç”¨åç§°"
        string category "åº”ç”¨åˆ†ç±»"
        string icon_url "å›¾æ ‡URL"
        long install_time "å®‰è£…æ—¶é—´"
        boolean is_system "æ˜¯å¦ç³»ç»Ÿåº”ç”¨"
    }
```

---

## ğŸ“Š è¯¦ç»†è¡¨ç»“æ„

### 1. åº”ç”¨ä¼šè¯è¡¨ï¼ˆapp_sessionï¼‰

**æ ¸å¿ƒè¡¨ï¼Œè®°å½•æ¯æ¬¡APPä½¿ç”¨ä¼šè¯**

```sql
CREATE TABLE app_session (
    session_id TEXT PRIMARY KEY,
    package_name TEXT NOT NULL,
    app_name TEXT NOT NULL,
    category TEXT NOT NULL,
    start_time INTEGER NOT NULL,
    end_time INTEGER NOT NULL,
    duration INTEGER NOT NULL DEFAULT 0,
    switch_count INTEGER NOT NULL DEFAULT 1,
    trigger_type TEXT NOT NULL DEFAULT 'UNKNOWN',
    exit_type TEXT NOT NULL DEFAULT 'UNKNOWN',
    collection_mode TEXT NOT NULL DEFAULT 'STANDARD',
    device_state TEXT NOT NULL DEFAULT 'UNKNOWN',
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000),
    updated_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

-- ç´¢å¼•
CREATE INDEX idx_app_session_package_name ON app_session(package_name);
CREATE INDEX idx_app_session_start_time ON app_session(start_time);
CREATE INDEX idx_app_session_date ON app_session(date(start_time/1000, 'unixepoch'));
CREATE INDEX idx_app_session_category ON app_session(category);
```

**é‡è¦ä¿®æ­£è¯´æ˜ï¼š**
- âœ… **è¡¨å**ï¼šä½¿ç”¨å•æ•° `app_session`ï¼ˆä¸æ˜¯ `app_sessions`ï¼‰
- âœ… **å­—æ®µ**ï¼šåˆ é™¤äº† `openCount` å­—æ®µï¼ˆé¿å…ä¸å…¨å±€ç»Ÿè®¡æ··æ·†ï¼‰
- âœ… **æ–°å¢**ï¼š`switch_count` å­—æ®µè¡¨ç¤ºæœ¬ä¼šè¯å†…çš„åˆ‡æ¢æ¬¡æ•°
- âœ… **ç»Ÿè®¡**ï¼šå…¨å±€"APPæ‰“å¼€æ¬¡æ•°"é€šè¿‡ `COUNT(*)` ç»Ÿè®¡è®°å½•æ•°
- âœ… **é˜ˆå€¼**ï¼šduration=0çš„è®°å½•ä¹Ÿå‚ä¸è®¡æ•°ï¼ˆä¿è¯ç»Ÿè®¡å‡†ç¡®ï¼‰

**å­—æ®µè¯¦ç»†è¯´æ˜ï¼š**

| å­—æ®µå | SQLç±»å‹ | Kotlinç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|---------|-----------|------|------|
| session_id | TEXT | String (UUID) | PRIMARY KEY | ä¼šè¯å”¯ä¸€æ ‡è¯†ï¼Œè‡ªåŠ¨ç”Ÿæˆ |
| package_name | TEXT | String | NOT NULL | åº”ç”¨åŒ…åï¼Œå¦‚ com.tencent.mm |
| app_name | TEXT | String | NOT NULL | åº”ç”¨æ˜¾ç¤ºåç§°ï¼Œå¦‚"å¾®ä¿¡" |
| category | TEXT | AppCategory(Enum) | NOT NULL | åº”ç”¨åˆ†ç±»æšä¸¾å€¼ |
| start_time | INTEGER | Long | NOT NULL | ä¼šè¯å¼€å§‹æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ |
| end_time | INTEGER | Long | NOT NULL | ä¼šè¯ç»“æŸæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ |
| duration | INTEGER | Long | DEFAULT 0 | ä½¿ç”¨æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰ï¼Œ<1ç§’è®¾ä¸º0 |
| switch_count | INTEGER | Int | DEFAULT 1 | æœ¬ä¼šè¯å†…åˆ‡æ¢æ¬¡æ•° |
| trigger_type | TEXT | TriggerType(Enum) | DEFAULT 'UNKNOWN' | è§¦å‘æ–¹å¼æšä¸¾å€¼ |
| exit_type | TEXT | ExitType(Enum) | DEFAULT 'UNKNOWN' | é€€å‡ºæ–¹å¼æšä¸¾å€¼ |
| collection_mode | TEXT | PerformanceMode(Enum) | DEFAULT 'STANDARD' | æ•°æ®æ”¶é›†æ¨¡å¼ |
| device_state | TEXT | DeviceState(Enum) | DEFAULT 'UNKNOWN' | è®¾å¤‡çŠ¶æ€æšä¸¾å€¼ |
| created_at | INTEGER | Long | è‡ªåŠ¨è®¾ç½® | è®°å½•åˆ›å»ºæ—¶é—´æˆ³ |
| updated_at | INTEGER | Long | è‡ªåŠ¨è®¾ç½® | è®°å½•æ›´æ–°æ—¶é—´æˆ³ |


**ä¸šåŠ¡è§„åˆ™æ–¹æ³•ï¼š**
- `isValidSession()`: åˆ¤æ–­æ˜¯å¦æœ‰æ•ˆä¼šè¯ï¼ˆduration >= 1000msï¼‰
- `getSessionDate()`: è·å–ä¼šè¯æ—¥æœŸï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰

### 2. åº”ç”¨ä½¿ç”¨æ˜ç»†è¡¨ï¼ˆapp_usage_detailï¼‰

**è®°å½•ä¼šè¯å†…çš„çŠ¶æ€å˜åŒ–**

```sql
CREATE TABLE app_usage_detail (
    detail_id TEXT PRIMARY KEY,
    session_id TEXT NOT NULL,
    timestamp INTEGER NOT NULL,
    state_type TEXT NOT NULL,
    FOREIGN KEY (session_id) REFERENCES app_session(session_id) ON DELETE CASCADE
);

CREATE INDEX idx_detail_session_id ON app_usage_detail(session_id);
CREATE INDEX idx_detail_timestamp ON app_usage_detail(timestamp);
```

**å­—æ®µè¯¦ç»†è¯´æ˜ï¼š**

| å­—æ®µå | SQLç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|---------|------|------|
| detail_id | TEXT | PRIMARY KEY | æ˜ç»†è®°å½•å”¯ä¸€æ ‡è¯†ï¼ˆUUIDï¼‰ |
| session_id | TEXT | FOREIGN KEY | å…³è”app_sessionè¡¨ |
| timestamp | INTEGER | NOT NULL | çŠ¶æ€å˜åŒ–æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ |
| state_type | TEXT | NOT NULL | çŠ¶æ€ç±»å‹æšä¸¾å€¼ |

**å¤–é”®å…³ç³»ï¼š**
- å¼•ç”¨è¡¨: app_session(session_id)
- åˆ é™¤ç­–ç•¥: CASCADEï¼ˆåˆ é™¤ä¼šè¯æ—¶åŒæ­¥åˆ é™¤æ˜ç»†ï¼‰

### 3. å±å¹•äº‹ä»¶è¡¨ï¼ˆscreen_eventï¼‰

**è®°å½•å±å¹•å¼€å…³å’Œè§£é”äº‹ä»¶**

```sql
CREATE TABLE screen_event (
    event_id TEXT PRIMARY KEY,
    event_type TEXT NOT NULL,
    timestamp INTEGER NOT NULL,
    duration INTEGER DEFAULT 0,
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

CREATE INDEX idx_screen_event_type ON screen_event(event_type);
CREATE INDEX idx_screen_event_timestamp ON screen_event(timestamp);
CREATE INDEX idx_screen_event_date ON screen_event(date(timestamp/1000, 'unixepoch'));
```

**å­—æ®µè¯¦ç»†è¯´æ˜ï¼š**

| å­—æ®µå | SQLç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|---------|------|------|
| event_id | TEXT | PRIMARY KEY | äº‹ä»¶å”¯ä¸€æ ‡è¯†ï¼ˆUUIDï¼‰ |
| event_type | TEXT | NOT NULL | äº‹ä»¶ç±»å‹: SCREEN_ON/SCREEN_OFF/USER_PRESENT |
| timestamp | INTEGER | NOT NULL | äº‹ä»¶å‘ç”Ÿæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ |
| duration | INTEGER | DEFAULT 0 | äº‹ä»¶æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ |
| created_at | INTEGER | è‡ªåŠ¨è®¾ç½® | è®°å½•åˆ›å»ºæ—¶é—´æˆ³ |

**ç´¢å¼•è®¾è®¡ï¼š**
- idx_screen_event_type: äº‹ä»¶ç±»å‹ç´¢å¼•
- idx_screen_event_timestamp: æ—¶é—´æˆ³ç´¢å¼•
- idx_screen_event_date: æ—¥æœŸç´¢å¼•ï¼ˆç”¨äºæŒ‰æ—¥æŸ¥è¯¢ï¼‰

### 4. é€šçŸ¥äº‹ä»¶è¡¨ï¼ˆnotification_eventï¼‰

**è®°å½•é€šçŸ¥å’Œç”¨æˆ·å“åº”**

```sql
CREATE TABLE notification_event (
    notification_id TEXT PRIMARY KEY,
    package_name TEXT NOT NULL,
    action TEXT NOT NULL,
    timestamp INTEGER NOT NULL,
    is_interactive BOOLEAN DEFAULT FALSE,
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

CREATE INDEX idx_notification_package ON notification_event(package_name);
CREATE INDEX idx_notification_timestamp ON notification_event(timestamp);
```

**å­—æ®µè¯¦ç»†è¯´æ˜ï¼š**

| å­—æ®µå | SQLç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|---------|------|------|
| notification_id | TEXT | PRIMARY KEY | é€šçŸ¥å”¯ä¸€æ ‡è¯†ï¼ˆUUIDï¼‰ |
| package_name | TEXT | NOT NULL | åº”ç”¨åŒ…å |
| action | TEXT | NOT NULL | ç”¨æˆ·æ“ä½œ: POSTED/CLICKED/DISMISSED |
| timestamp | INTEGER | NOT NULL | æ“ä½œæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ |
| is_interactive | BOOLEAN | DEFAULT FALSE | æ˜¯å¦ä¸ºäº¤äº’å¼é€šçŸ¥ |
| created_at | INTEGER | è‡ªåŠ¨è®¾ç½® | è®°å½•åˆ›å»ºæ—¶é—´æˆ³ |

**ç´¢å¼•è®¾è®¡ï¼š**
- idx_notification_package: åŒ…åç´¢å¼•
- idx_notification_timestamp: æ—¶é—´æˆ³ç´¢å¼•

### 5. æ¯æ—¥æ±‡æ€»è¡¨ï¼ˆdaily_summaryï¼‰

**é¢„è®¡ç®—çš„æ¯æ—¥ç»Ÿè®¡æ•°æ®**

```sql
CREATE TABLE daily_summary (
    summary_id TEXT PRIMARY KEY,
    date TEXT UNIQUE NOT NULL,
    total_screen_time INTEGER NOT NULL DEFAULT 0,
    phone_unlock_count INTEGER NOT NULL DEFAULT 0,
    app_open_count INTEGER NOT NULL DEFAULT 0,
    app_usage_duration INTEGER NOT NULL DEFAULT 0,
    goal_progress INTEGER DEFAULT 0,
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000),
    updated_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

CREATE INDEX idx_daily_summary_date ON daily_summary(date);
```

**å­—æ®µè¯¦ç»†è¯´æ˜ï¼ˆå››å¤§æ ¸å¿ƒæŒ‡æ ‡ï¼‰ï¼š**

| å­—æ®µå | SQLç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|---------|------|------|
| summary_id | TEXT | PRIMARY KEY | æ±‡æ€»è®°å½•å”¯ä¸€æ ‡è¯†ï¼ˆUUIDï¼‰ |
| date | TEXT | UNIQUE NOT NULL | æ—¥æœŸï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰ |
| **total_screen_time** | INTEGER | DEFAULT 0 | ğŸ“± ä»Šæ—¥å±å¹•æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰ |
| **phone_unlock_count** | INTEGER | DEFAULT 0 | ğŸ”“ æ‰‹æœºè§£é”æ¬¡æ•° |
| **app_open_count** | INTEGER | DEFAULT 0 | ğŸ“² APPæ‰“å¼€æ¬¡æ•° |
| **app_usage_duration** | INTEGER | DEFAULT 0 | ğŸ”† APPä½¿ç”¨æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰ |
| goal_progress | INTEGER | DEFAULT 0 | ç›®æ ‡å®Œæˆåº¦ï¼ˆç™¾åˆ†æ¯”ï¼‰ |
| created_at | INTEGER | è‡ªåŠ¨è®¾ç½® | è®°å½•åˆ›å»ºæ—¶é—´æˆ³ |
| updated_at | INTEGER | è‡ªåŠ¨è®¾ç½® | è®°å½•æ›´æ–°æ—¶é—´æˆ³ |

**ç´¢å¼•è®¾è®¡ï¼š**
- idx_daily_summary_date: æ—¥æœŸå”¯ä¸€ç´¢å¼•

**ç”¨é€”è¯´æ˜ï¼š**
- é¢„è®¡ç®—çš„æ¯æ—¥ç»Ÿè®¡æ•°æ®ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
- é¿å…æ¯æ¬¡æŸ¥è¯¢éƒ½è¿›è¡Œèšåˆè®¡ç®—
- æ”¯æŒå†å²æ•°æ®å¿«é€Ÿæ£€ç´¢

### 6. ç”¨æˆ·ç›®æ ‡è¡¨ï¼ˆuser_goalï¼‰

**ç”¨æˆ·è®¾å®šçš„ä½¿ç”¨ç›®æ ‡**

```sql
CREATE TABLE user_goal (
    goal_id TEXT PRIMARY KEY,
    goal_type TEXT NOT NULL,
    target_value INTEGER NOT NULL,
    current_value INTEGER DEFAULT 0,
    period TEXT NOT NULL DEFAULT 'DAILY',
    is_active BOOLEAN DEFAULT TRUE,
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000),
    updated_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

CREATE INDEX idx_user_goal_type ON user_goal(goal_type);
CREATE INDEX idx_user_goal_active ON user_goal(is_active);
```

**å­—æ®µè¯¦ç»†è¯´æ˜ï¼š**

| å­—æ®µå | SQLç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|---------|------|------|
| goal_id | TEXT | PRIMARY KEY | ç›®æ ‡å”¯ä¸€æ ‡è¯†ï¼ˆUUIDï¼‰ |
| goal_type | TEXT | NOT NULL | ç›®æ ‡ç±»å‹æšä¸¾å€¼ |
| target_value | INTEGER | NOT NULL | ç›®æ ‡å€¼ï¼ˆæ¯«ç§’æˆ–æ¬¡æ•°ï¼‰ |
| current_value | INTEGER | DEFAULT 0 | å½“å‰å€¼ï¼ˆå®æ—¶æ›´æ–°ï¼‰ |
| period | TEXT | DEFAULT 'DAILY' | ç»Ÿè®¡å‘¨æœŸ: DAILY/WEEKLY/MONTHLY |
| is_active | BOOLEAN | DEFAULT TRUE | æ˜¯å¦æ¿€æ´» |
| created_at | INTEGER | è‡ªåŠ¨è®¾ç½® | è®°å½•åˆ›å»ºæ—¶é—´æˆ³ |
| updated_at | INTEGER | è‡ªåŠ¨è®¾ç½® | è®°å½•æ›´æ–°æ—¶é—´æˆ³ |

**ç´¢å¼•è®¾è®¡ï¼š**
- idx_user_goal_type: ç›®æ ‡ç±»å‹ç´¢å¼•
- idx_user_goal_active: æ¿€æ´»çŠ¶æ€ç´¢å¼•

**ä¸šåŠ¡è§„åˆ™ï¼š**
- `getProgressPercentage()`: è®¡ç®—å®Œæˆåº¦ç™¾åˆ†æ¯” = (current_value * 100) / target_value

### 7. åº”ç”¨å…ƒæ•°æ®è¡¨ï¼ˆapp_metadataï¼‰

**ç¼“å­˜åº”ç”¨ä¿¡æ¯**

```sql
CREATE TABLE app_metadata (
    package_name TEXT PRIMARY KEY,
    app_name TEXT NOT NULL,
    category TEXT NOT NULL DEFAULT 'OTHER',
    icon_url TEXT,
    install_time INTEGER,
    is_system BOOLEAN DEFAULT FALSE,
    last_updated INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

CREATE INDEX idx_app_metadata_category ON app_metadata(category);
```

**å­—æ®µè¯¦ç»†è¯´æ˜ï¼š**

| å­—æ®µå | SQLç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|---------|------|------|
| package_name | TEXT | PRIMARY KEY | åº”ç”¨åŒ…åï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰ |
| app_name | TEXT | NOT NULL | åº”ç”¨æ˜¾ç¤ºåç§° |
| category | TEXT | DEFAULT 'OTHER' | åº”ç”¨åˆ†ç±»æšä¸¾å€¼ |
| icon_url | TEXT | å¯ä¸ºç©º | åº”ç”¨å›¾æ ‡URLï¼ˆæœ¬åœ°æˆ–è¿œç¨‹ï¼‰ |
| install_time | INTEGER | å¯ä¸ºç©º | åº”ç”¨å®‰è£…æ—¶é—´æˆ³ |
| is_system | BOOLEAN | DEFAULT FALSE | æ˜¯å¦ä¸ºç³»ç»Ÿåº”ç”¨ |
| last_updated | INTEGER | è‡ªåŠ¨è®¾ç½® | å…ƒæ•°æ®æ›´æ–°æ—¶é—´æˆ³ |

**ç´¢å¼•è®¾è®¡ï¼š**
- idx_app_metadata_category: åˆ†ç±»ç´¢å¼•

**ç”¨é€”è¯´æ˜ï¼š**
- ç¼“å­˜åº”ç”¨åŸºæœ¬ä¿¡æ¯ï¼Œå‡å°‘ç³»ç»ŸæŸ¥è¯¢
- æ”¯æŒåº”ç”¨åˆ†ç±»ç»Ÿè®¡
- è¯†åˆ«ç³»ç»Ÿåº”ç”¨å’Œç”¨æˆ·åº”ç”¨

---

## ğŸ” æŸ¥è¯¢ç¤ºä¾‹

### 1. ä»Šæ—¥å››å¤§æ ¸å¿ƒæŒ‡æ ‡æŸ¥è¯¢

**æŸ¥è¯¢1ï¼šä»Šæ—¥APPæ‰“å¼€æ¬¡æ•°**
```sql
-- ç»Ÿè®¡ä»Šæ—¥app_sessionè¡¨çš„è®°å½•æ¡æ•°
SELECT COUNT(*) 
FROM app_session 
WHERE date(start_time/1000, 'unixepoch') = date('now')
```
**è¯´æ˜**ï¼šæ¯æ¡è®°å½•ä»£è¡¨ä¸€æ¬¡APPåˆ‡æ¢åˆ°å‰å°ï¼Œç›´æ¥ç»Ÿè®¡è®°å½•æ•°å³å¯

**æŸ¥è¯¢2ï¼šä»Šæ—¥APPä½¿ç”¨æ—¶é•¿**
```sql
-- æ±‡æ€»ä»Šæ—¥æ‰€æœ‰APPä½¿ç”¨æ—¶é•¿
SELECT COALESCE(SUM(duration), 0) 
FROM app_session 
WHERE date(start_time/1000, 'unixepoch') = date('now')
```
**è¯´æ˜**ï¼šåŒ…å«æ‰€æœ‰è®°å½•ï¼ˆå«duration=0ï¼‰ï¼ŒCOALESCEå¤„ç†æ— æ•°æ®æƒ…å†µ

**æŸ¥è¯¢3ï¼šä»Šæ—¥å±å¹•æ—¶é•¿**
```sql
-- ç»Ÿè®¡SCREEN_ONäº‹ä»¶çš„æ€»æ—¶é•¿
SELECT COALESCE(SUM(duration), 0) 
FROM screen_event 
WHERE event_type = 'SCREEN_ON' 
AND date(timestamp/1000, 'unixepoch') = date('now')
```
**è¯´æ˜**ï¼šéœ€è¦é€šè¿‡SCREEN_ON/OFFäº‹ä»¶é…å¯¹è®¡ç®—ï¼Œdurationå­—æ®µå·²é¢„è®¡ç®—

**æŸ¥è¯¢4ï¼šä»Šæ—¥æ‰‹æœºè§£é”æ¬¡æ•°**

```sql
-- ç»Ÿè®¡USER_PRESENTäº‹ä»¶æ•°é‡
SELECT COUNT(*) 
FROM screen_event 
WHERE event_type = 'USER_PRESENT' 
AND date(timestamp/1000, 'unixepoch') = date('now')
```
**è¯´æ˜**ï¼šæ¯æ¬¡è§£é”è§¦å‘ä¸€æ¬¡USER_PRESENTäº‹ä»¶

### 2. åº”ç”¨åˆ†ç±»ç»Ÿè®¡

**æŸ¥è¯¢1ï¼šä»Šæ—¥å„åˆ†ç±»ä½¿ç”¨ç»Ÿè®¡**
```sql
-- æŒ‰åˆ†ç±»æ±‡æ€»ä¼šè¯æ•°å’Œæ€»æ—¶é•¿
SELECT 
    category, 
    COUNT(*) as session_count,        -- æ‰“å¼€æ¬¡æ•°
    SUM(duration) as total_duration   -- ä½¿ç”¨æ—¶é•¿
FROM app_session 
WHERE date(start_time/1000, 'unixepoch') = date('now')
GROUP BY category
ORDER BY total_duration DESC
```
**ç»“æœç¤ºä¾‹**ï¼š
| category | session_count | total_duration |
|----------|--------------|----------------|
| ç¤¾äº¤ | 45 | 7200000 (2å°æ—¶) |
| å¨±ä¹ | 23 | 5400000 (1.5å°æ—¶) |
| å·¥å…· | 18 | 1800000 (30åˆ†é’Ÿ) |

**æŸ¥è¯¢2ï¼šä»Šæ—¥å„åˆ†ç±»æ‰“å¼€æ¬¡æ•°æ’è¡Œ**
```sql
-- æŒ‰æ‰“å¼€æ¬¡æ•°æ’åº
SELECT 
    category, 
    COUNT(*) as open_count
FROM app_session 
WHERE date(start_time/1000, 'unixepoch') = date('now')
GROUP BY category
ORDER BY open_count DESC
```

### 3. æœ€æ´»è·ƒåº”ç”¨ç»Ÿè®¡

**æŸ¥è¯¢1ï¼šä»Šæ—¥æœ€æ´»è·ƒåº”ç”¨ï¼ˆæŒ‰æ—¶é•¿æ’åºï¼‰**
```sql
-- ç»Ÿè®¡æ¯ä¸ªAPPçš„ä½¿ç”¨æƒ…å†µï¼ŒæŒ‰æ€»æ—¶é•¿æ’åº
SELECT 
    package_name, 
    app_name, 
    category, 
    COUNT(*) as session_count,           -- æ‰“å¼€æ¬¡æ•°
    SUM(duration) as total_duration,     -- æ€»ä½¿ç”¨æ—¶é•¿
    AVG(duration) as avg_duration        -- å¹³å‡å•æ¬¡æ—¶é•¿
FROM app_session 
WHERE date(start_time/1000, 'unixepoch') = date('now')
GROUP BY package_name
ORDER BY total_duration DESC
LIMIT 10
```
**ç»“æœç¤ºä¾‹**ï¼š
| app_name | session_count | total_duration | avg_duration |
|----------|--------------|----------------|--------------|
| å¾®ä¿¡ | 23 | 7200000 (2å°æ—¶) | 313043 (5.2åˆ†é’Ÿ) |
| æŠ–éŸ³ | 15 | 5400000 (1.5å°æ—¶) | 360000 (6åˆ†é’Ÿ) |

**æŸ¥è¯¢2ï¼šä»Šæ—¥æœ€é¢‘ç¹æ‰“å¼€åº”ç”¨ï¼ˆæŒ‰æ¬¡æ•°æ’åºï¼‰**
```sql
-- æŒ‰æ‰“å¼€æ¬¡æ•°æ’åºï¼ˆä¸è€ƒè™‘æ—¶é•¿ï¼‰
SELECT 
    package_name, 
    app_name, 
    category, 
    COUNT(*) as open_count
FROM app_session 
WHERE date(start_time/1000, 'unixepoch') = date('now')
GROUP BY package_name
ORDER BY open_count DESC
LIMIT 10
```
**åº”ç”¨åœºæ™¯**ï¼š
- æŸ¥è¯¢1ï¼šæŸ¥çœ‹å“ªäº›APPå ç”¨æ—¶é—´æœ€å¤š
- æŸ¥è¯¢2ï¼šæŸ¥çœ‹å“ªäº›APPåˆ‡æ¢æœ€é¢‘ç¹

---

## âš ï¸ æ•°æ®ä¸€è‡´æ€§è§„åˆ™

### 1. æœ€å°æ—¶é•¿é˜ˆå€¼å¤„ç†

**åŸåˆ™ï¼šè¡Œä¸ºå¿…é¡»è®°å½•ï¼Œæ—¶é•¿å¯ä»¥è¿‡æ»¤**

**å¤„ç†é€»è¾‘**ï¼š
```mermaid
flowchart TD
    A[ä¼šè¯ç»“æŸ] --> B[è®¡ç®—å®é™…æ—¶é•¿<br/>actualDuration = endTime - startTime]
    B --> C{actualDuration < 1000ms?}
    C -->|æ˜¯| D[è®¾ç½® duration = 0]
    C -->|å¦| E[è®¾ç½® duration = actualDuration]
    D --> F[ä¿å­˜ä¼šè¯è®°å½•]
    E --> F
    F --> G[è®°å½•å‚ä¸æ‰“å¼€æ¬¡æ•°ç»Ÿè®¡]
```

**æ ¸å¿ƒè¦ç‚¹**ï¼š
1. **å¿…é¡»ä¿å­˜è®°å½•**ï¼šæ— è®ºä½¿ç”¨æ—¶é•¿å¤šçŸ­ï¼Œéƒ½è¦ä¿å­˜åˆ°æ•°æ®åº“
2. **æ—¶é•¿å¯ä»¥ä¸º0**ï¼š< 1ç§’çš„ä¼šè¯ï¼Œdurationå­—æ®µè®¾ä¸º0
3. **ç»Ÿè®¡ä»ç„¶å‡†ç¡®**ï¼š
   - APPæ‰“å¼€æ¬¡æ•° = COUNT(*) âœ… ï¼ˆåŒ…å«æ‰€æœ‰è®°å½•ï¼‰
   - APPä½¿ç”¨æ—¶é•¿ = SUM(duration) âœ… ï¼ˆè‡ªåŠ¨è¿‡æ»¤0æ—¶é•¿ï¼‰

### 2. ç»Ÿè®¡æŸ¥è¯¢ä¸€è‡´æ€§

**ç»Ÿè®¡æ–¹å¼å¯¹æ¯”**ï¼š

| ç»Ÿè®¡æŒ‡æ ‡ | SQLæŸ¥è¯¢ | æ˜¯å¦åŒ…å«duration=0è®°å½• | è¯´æ˜ |
|---------|---------|---------------------|------|
| APPæ‰“å¼€æ¬¡æ•° | `COUNT(*)` | âœ… åŒ…å« | æ‰€æœ‰è®°å½•éƒ½è®¡æ•° |
| APPä½¿ç”¨æ—¶é•¿ | `SUM(duration)` | âœ… è‡ªåŠ¨å¿½ç•¥ | SUMè‡ªåŠ¨è·³è¿‡0å€¼ |

**æŸ¥è¯¢ç¤ºä¾‹**ï¼š

**æ–¹å¼1ï¼šåŒ…å«æ‰€æœ‰è®°å½•ï¼ˆæ¨èï¼‰**
```sql
-- APPæ‰“å¼€æ¬¡æ•°
SELECT COUNT(*) FROM app_session WHERE date = :date

-- APPä½¿ç”¨æ—¶é•¿ï¼ˆè‡ªåŠ¨è¿‡æ»¤0æ—¶é•¿ï¼‰
SELECT SUM(duration) FROM app_session WHERE date = :date
```

**æ–¹å¼2ï¼šæ˜¾å¼è¿‡æ»¤çŸ­æ—¶ä¼šè¯ï¼ˆå¯é€‰ï¼‰**
```sql
-- åªç»Ÿè®¡æœ‰æ•ˆä¼šè¯
SELECT SUM(duration) FROM app_session 
WHERE date = :date AND duration >= 1000
```

**æ¨èä½¿ç”¨æ–¹å¼1**ï¼Œå› ä¸ºï¼š
- æ‰“å¼€æ¬¡æ•°ç»Ÿè®¡æ›´å‡†ç¡®
- SUMä¼šè‡ªåŠ¨è·³è¿‡duration=0çš„è®°å½•
- æŸ¥è¯¢é€»è¾‘æ›´ç®€å•

---

## ğŸ”§ æ•°æ®åº“å‡çº§ç­–ç•¥

### ä»v1.0åˆ°v2.1çš„è¿ç§»

**æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†**ï¼š

| ç‰ˆæœ¬å· | åŒ…å«å®ä½“ | æ›´æ–°å†…å®¹ |
|--------|---------|---------|
| v1 | usage_tracking | æ—§ç‰ˆæœ¬ï¼ˆå¾…åºŸå¼ƒï¼‰ |
| v2 | åŸºç¡€è¡¨ | åˆå§‹åŒ–æ–°è¡¨ç»“æ„ |
| v3 | 7å¼ æ ¸å¿ƒè¡¨ | å®Œæ•´v2.1æ¶æ„ |

**æ ¸å¿ƒå®ä½“æ¸…å•**ï¼š
1. AppSession - åº”ç”¨ä¼šè¯è¡¨
2. AppUsageDetail - ä¼šè¯æ˜ç»†è¡¨
3. ScreenEvent - å±å¹•äº‹ä»¶è¡¨
4. NotificationEvent - é€šçŸ¥äº‹ä»¶è¡¨
5. DailySummary - æ¯æ—¥æ±‡æ€»è¡¨
6. UserGoal - ç”¨æˆ·ç›®æ ‡è¡¨
7. AppMetadata - åº”ç”¨å…ƒæ•°æ®è¡¨

**è¿ç§»æµç¨‹ï¼ˆv2 â†’ v3ï¼‰**ï¼š

```mermaid
flowchart TD
    A[å¼€å§‹è¿ç§»] --> B[1. é‡å‘½åæ—§è¡¨<br/>app_sessions â†’ app_session_old]
    B --> C[2. åˆ›å»ºæ–°è¡¨<br/>app_session with new schema]
    C --> D[3. æ•°æ®è¿ç§»<br/>å¤„ç†å­—æ®µå˜åŒ–]
    D --> E[4. åˆ é™¤æ—§è¡¨]
    E --> F[5. åˆ›å»ºç´¢å¼•]
    F --> G[å®Œæˆè¿ç§»]
```

**å­—æ®µè¿ç§»æ˜ å°„**ï¼š
- session_id: ä¿æŒä¸å˜ï¼ˆè‹¥ä¸ºç©ºåˆ™ç”ŸæˆUUIDï¼‰
- open_count â†’ switch_count (è¯­ä¹‰å˜æ›´)
- æ–°å¢å­—æ®µä½¿ç”¨é»˜è®¤å€¼

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

* [æœ¯è¯­ç»Ÿä¸€è¡¨ v2.1](./æœ¯è¯­ç»Ÿä¸€è¡¨.md) - æœ¯è¯­æƒå¨æ ‡å‡†

* [æ ¸å¿ƒæŒ‡æ ‡å®šä¹‰è¯´æ˜](./æ ¸å¿ƒæŒ‡æ ‡å®šä¹‰è¯´æ˜.md) - ç»Ÿè®¡é€»è¾‘è¯¦ç»†è¯´æ˜

* [æŠ€æœ¯è¯´æ˜_ç»Ÿè®¡ç³»ç»Ÿæ¶æ„](./æŠ€æœ¯è¯´æ˜_ç»Ÿè®¡ç³»ç»Ÿæ¶æ„.md) - ç³»ç»Ÿæ¶æ„è¯´æ˜

* [å‰ç«¯UIè®¾è®¡æ–¹æ¡ˆ v2](./å‰ç«¯UIè®¾è®¡æ–¹æ¡ˆ_v2.md) - UIè®¾è®¡è§„èŒƒ

* [å®ç°è·¯çº¿å›¾ v2](./å®ç°è·¯çº¿å›¾_v2.md) - å¼€å‘è®¡åˆ’

---

## ğŸ“ ç‰ˆæœ¬å†å²

* **v2.1 (2025-10-15)**ï¼š

  * âœ… ç»Ÿä¸€è¡¨åä¸ºå•æ•°å½¢å¼ï¼ˆapp\_sessionç­‰ï¼‰

  * âœ… åˆ é™¤openCountå­—æ®µï¼Œæ”¹ç”¨COUNT(\*)ç»Ÿè®¡

  * âœ… æ–°å¢switch\_countå­—æ®µè¡¨ç¤ºä¼šè¯å†…åˆ‡æ¢æ¬¡æ•°

  * âœ… æ˜ç¡®æœ€å°æ—¶é•¿é˜ˆå€¼å¤„ç†é€»è¾‘ï¼ˆ<1ç§’è®¾ä¸º0ï¼‰

  * âœ… ä¸æœ¯è¯­ç»Ÿä¸€è¡¨v2.1å®Œå…¨åŒæ­¥

* **v2.0 (2025-10-14)**ï¼š

  * åˆå§‹ç‰ˆæœ¬ï¼Œå¼•å…¥å››å¤§æ ¸å¿ƒæŒ‡æ ‡

  * è®¾è®¡AppSessionç­‰æ–°æ•°æ®ç»“æ„

* **v1.0 (æ—§ç‰ˆ)**ï¼š

  * ä½¿ç”¨å¤æ•°è¡¨åå’ŒopenCountå­—æ®µ

  * æœ¯è¯­å®šä¹‰ä¸ç»Ÿä¸€

