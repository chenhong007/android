# 数据模型设计方案 v2.2

> **版本：** v2.2  
> **更新日期：** 2025-10-15  
> **文档状态：** 新增多时间维度统计支持，支持日/周/月/年/自定义维度查询  
> **权威来源：** 与《术语统一表 v2.3》完全同步

---

## 🎯 设计原则

1. **统一术语**：所有表名、字段名严格遵循《术语统一表 v2.1》
2. **单数表名**：所有表名使用单数形式（如 `app_session` 而非 `app_sessions`）
3. **行为记录**：无论使用时长多短，行为必须记录（保证统计准确）
4. **时长过滤**：短时会话duration设为0，但记录保留（用于准确计数）
5. **版本同步**：与术语表、技术架构文档保持完全一致

---

## 🏗️ 数据库架构

### ER图（实体关系图）

```mermaid
erDiagram
    app_session ||--o{ app_usage_detail : contains
    app_session ||--o{ daily_summary : contributes_to
    app_session ||--o{ daily_app_summary : contributes_to
    screen_event ||--o{ daily_summary : contributes_to
    daily_summary ||--o{ weekly_summary : aggregates_to
    daily_summary ||--o{ monthly_summary : aggregates_to
    daily_summary ||--o{ yearly_summary : aggregates_to
    user_goal ||--o{ daily_summary : tracks_progress
    app_metadata ||--o{ app_session : references
    app_metadata ||--o{ daily_app_summary : references
    notification_event ||--o{ app_session : may_trigger
    
    app_session {
        string session_id PK "会话唯一ID"
        string package_name FK "应用包名"
        long start_time "开始时间"
        long end_time "结束时间"
        long duration "使用时长"
        int switch_count "切换次数"
        string category "应用分类"
        string trigger_type "触发方式"
        string exit_type "退出方式"
        string collection_mode "收集模式"
        string device_state "设备状态"
    }
    
    app_usage_detail {
        string detail_id PK "明细ID"
        string session_id FK "会话ID"
        long timestamp "时间戳"
        string state_type "状态类型"
    }
    
    screen_event {
        string event_id PK "事件ID"
        string event_type "事件类型"
        long timestamp "时间戳"
        long duration "事件持续时间"
    }
    
    notification_event {
        string notification_id PK "通知ID"
        string package_name "应用包名"
        string action "用户操作"
        long timestamp "时间戳"
        boolean is_interactive "是否交互"
    }
    
    daily_summary {
        string summary_id PK "汇总ID"
        string date "日期"
        long total_screen_time "今日屏幕时长"
        int phone_unlock_count "手机解锁次数"
        int app_open_count "APP打开次数"
        long app_usage_duration "APP使用时长"
        int goal_progress "目标进度"
    }
    
    daily_app_summary {
        string summary_id PK "汇总ID"
        string date "日期"
        string package_name "应用包名"
        string app_name "应用名称"
        string category "应用分类"
        int app_open_count "APP打开次数"
        long app_usage_duration "APP使用时长"
    }
    
    weekly_summary {
        string summary_id PK "汇总ID"
        string week_key "周标识"
        int year "年份"
        int week_number "周数"
        string start_date "起始日期"
        string end_date "结束日期"
        long total_screen_time "周屏幕时长"
        int phone_unlock_count "周解锁次数"
        int app_open_count "周APP打开次数"
        long app_usage_duration "周APP使用时长"
    }
    
    monthly_summary {
        string summary_id PK "汇总ID"
        string month_key "月标识"
        int year "年份"
        int month "月份"
        long total_screen_time "月屏幕时长"
        int phone_unlock_count "月解锁次数"
        int app_open_count "月APP打开次数"
        long app_usage_duration "月APP使用时长"
    }
    
    yearly_summary {
        string summary_id PK "汇总ID"
        int year "年份"
        long total_screen_time "年屏幕时长"
        int phone_unlock_count "年解锁次数"
        int app_open_count "年APP打开次数"
        long app_usage_duration "年APP使用时长"
    }
    
    user_goal {
        string goal_id PK "目标ID"
        string goal_type "目标类型"
        long target_value "目标值"
        long current_value "当前值"
        string period "周期"
        boolean is_active "是否激活"
    }
    
    app_metadata {
        string package_name PK "应用包名"
        string app_name "应用名称"
        string category "应用分类"
        string icon_url "图标URL"
        long install_time "安装时间"
        boolean is_system "是否系统应用"
    }
```

---

## 📊 详细表结构

### 1. 应用会话表（app_session）

**核心表，记录每次APP使用会话**

```sql
CREATE TABLE app_session (
    session_id TEXT PRIMARY KEY,
    package_name TEXT NOT NULL,
    app_name TEXT NOT NULL,
    category TEXT NOT NULL,
    start_time INTEGER NOT NULL,
    end_time INTEGER NOT NULL,
    duration INTEGER NOT NULL DEFAULT 0,
    switch_count INTEGER NOT NULL DEFAULT 1,
    trigger_type TEXT NOT NULL DEFAULT 'UNKNOWN',
    exit_type TEXT NOT NULL DEFAULT 'UNKNOWN',
    collection_mode TEXT NOT NULL DEFAULT 'STANDARD',
    device_state TEXT NOT NULL DEFAULT 'UNKNOWN',
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000),
    updated_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

-- 索引
CREATE INDEX idx_app_session_package_name ON app_session(package_name);
CREATE INDEX idx_app_session_start_time ON app_session(start_time);
CREATE INDEX idx_app_session_date ON app_session(date(start_time/1000, 'unixepoch'));
CREATE INDEX idx_app_session_category ON app_session(category);
```

**重要修正说明：**
- ✅ **表名**：使用单数 `app_session`（不是 `app_sessions`）
- ✅ **字段**：删除了 `openCount` 字段（避免与全局统计混淆）
- ✅ **新增**：`switch_count` 字段表示本会话内的切换次数
- ✅ **统计**：全局"APP打开次数"通过 `COUNT(*)` 统计记录数
- ✅ **阈值**：duration=0的记录也参与计数（保证统计准确）

**字段详细说明：**

| 字段名 | SQL类型 | Kotlin类型 | 约束 | 说明 |
|--------|---------|-----------|------|------|
| session_id | TEXT | String (UUID) | PRIMARY KEY | 会话唯一标识，自动生成 |
| package_name | TEXT | String | NOT NULL | 应用包名，如 com.tencent.mm |
| app_name | TEXT | String | NOT NULL | 应用显示名称，如"微信" |
| category | TEXT | AppCategory(Enum) | NOT NULL | 应用分类枚举值 |
| start_time | INTEGER | Long | NOT NULL | 会话开始时间戳（毫秒） |
| end_time | INTEGER | Long | NOT NULL | 会话结束时间戳（毫秒） |
| duration | INTEGER | Long | DEFAULT 0 | 使用时长（毫秒），<1秒设为0 |
| switch_count | INTEGER | Int | DEFAULT 1 | 本会话内切换次数 |
| trigger_type | TEXT | TriggerType(Enum) | DEFAULT 'UNKNOWN' | 触发方式枚举值 |
| exit_type | TEXT | ExitType(Enum) | DEFAULT 'UNKNOWN' | 退出方式枚举值 |
| collection_mode | TEXT | PerformanceMode(Enum) | DEFAULT 'STANDARD' | 数据收集模式 |
| device_state | TEXT | DeviceState(Enum) | DEFAULT 'UNKNOWN' | 设备状态枚举值 |
| created_at | INTEGER | Long | 自动设置 | 记录创建时间戳 |
| updated_at | INTEGER | Long | 自动设置 | 记录更新时间戳 |


**业务规则方法：**
- `isValidSession()`: 判断是否有效会话（duration >= 1000ms）
- `getSessionDate()`: 获取会话日期（YYYY-MM-DD格式）

### 2. 应用使用明细表（app_usage_detail）

**记录会话内的状态变化**

```sql
CREATE TABLE app_usage_detail (
    detail_id TEXT PRIMARY KEY,
    session_id TEXT NOT NULL,
    timestamp INTEGER NOT NULL,
    state_type TEXT NOT NULL,
    FOREIGN KEY (session_id) REFERENCES app_session(session_id) ON DELETE CASCADE
);

CREATE INDEX idx_detail_session_id ON app_usage_detail(session_id);
CREATE INDEX idx_detail_timestamp ON app_usage_detail(timestamp);
```

**字段详细说明：**

| 字段名 | SQL类型 | 约束 | 说明 |
|--------|---------|------|------|
| detail_id | TEXT | PRIMARY KEY | 明细记录唯一标识（UUID） |
| session_id | TEXT | FOREIGN KEY | 关联app_session表 |
| timestamp | INTEGER | NOT NULL | 状态变化时间戳（毫秒） |
| state_type | TEXT | NOT NULL | 状态类型枚举值 |

**外键关系：**
- 引用表: app_session(session_id)
- 删除策略: CASCADE（删除会话时同步删除明细）

### 3. 屏幕事件表（screen_event）

**记录屏幕开关和解锁事件**

```sql
CREATE TABLE screen_event (
    event_id TEXT PRIMARY KEY,
    event_type TEXT NOT NULL,
    timestamp INTEGER NOT NULL,
    duration INTEGER DEFAULT 0,
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

CREATE INDEX idx_screen_event_type ON screen_event(event_type);
CREATE INDEX idx_screen_event_timestamp ON screen_event(timestamp);
CREATE INDEX idx_screen_event_date ON screen_event(date(timestamp/1000, 'unixepoch'));
```

**字段详细说明：**

| 字段名 | SQL类型 | 约束 | 说明 |
|--------|---------|------|------|
| event_id | TEXT | PRIMARY KEY | 事件唯一标识（UUID） |
| event_type | TEXT | NOT NULL | 事件类型: SCREEN_ON/SCREEN_OFF/USER_PRESENT |
| timestamp | INTEGER | NOT NULL | 事件发生时间戳（毫秒） |
| duration | INTEGER | DEFAULT 0 | 事件持续时间（毫秒） |
| created_at | INTEGER | 自动设置 | 记录创建时间戳 |

**索引设计：**
- idx_screen_event_type: 事件类型索引
- idx_screen_event_timestamp: 时间戳索引
- idx_screen_event_date: 日期索引（用于按日查询）

### 4. 通知事件表（notification_event）

**记录通知和用户响应**

```sql
CREATE TABLE notification_event (
    notification_id TEXT PRIMARY KEY,
    package_name TEXT NOT NULL,
    action TEXT NOT NULL,
    timestamp INTEGER NOT NULL,
    is_interactive BOOLEAN DEFAULT FALSE,
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

CREATE INDEX idx_notification_package ON notification_event(package_name);
CREATE INDEX idx_notification_timestamp ON notification_event(timestamp);
```

**字段详细说明：**

| 字段名 | SQL类型 | 约束 | 说明 |
|--------|---------|------|------|
| notification_id | TEXT | PRIMARY KEY | 通知唯一标识（UUID） |
| package_name | TEXT | NOT NULL | 应用包名 |
| action | TEXT | NOT NULL | 用户操作: POSTED/CLICKED/DISMISSED |
| timestamp | INTEGER | NOT NULL | 操作时间戳（毫秒） |
| is_interactive | BOOLEAN | DEFAULT FALSE | 是否为交互式通知 |
| created_at | INTEGER | 自动设置 | 记录创建时间戳 |

**索引设计：**
- idx_notification_package: 包名索引
- idx_notification_timestamp: 时间戳索引

### 5. 每日汇总表（daily_summary）

**预计算的每日统计数据**

```sql
CREATE TABLE daily_summary (
    summary_id TEXT PRIMARY KEY,
    date TEXT UNIQUE NOT NULL,
    total_screen_time INTEGER NOT NULL DEFAULT 0,
    phone_unlock_count INTEGER NOT NULL DEFAULT 0,
    app_open_count INTEGER NOT NULL DEFAULT 0,
    app_usage_duration INTEGER NOT NULL DEFAULT 0,
    goal_progress INTEGER DEFAULT 0,
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000),
    updated_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

CREATE INDEX idx_daily_summary_date ON daily_summary(date);
```

**字段详细说明（四大核心指标）：**

| 字段名 | SQL类型 | 约束 | 说明 |
|--------|---------|------|------|
| summary_id | TEXT | PRIMARY KEY | 汇总记录唯一标识（UUID） |
| date | TEXT | UNIQUE NOT NULL | 日期（YYYY-MM-DD格式） |
| **total_screen_time** | INTEGER | DEFAULT 0 | 📱 今日屏幕时长（毫秒） |
| **phone_unlock_count** | INTEGER | DEFAULT 0 | 🔓 手机解锁次数 |
| **app_open_count** | INTEGER | DEFAULT 0 | 📲 APP打开次数 |
| **app_usage_duration** | INTEGER | DEFAULT 0 | 🔆 APP使用时长（毫秒） |
| goal_progress | INTEGER | DEFAULT 0 | 目标完成度（百分比） |
| created_at | INTEGER | 自动设置 | 记录创建时间戳 |
| updated_at | INTEGER | 自动设置 | 记录更新时间戳 |

**索引设计：**
- idx_daily_summary_date: 日期唯一索引

**用途说明：**
- 预计算的每日统计数据，提升查询性能
- 避免每次查询都进行聚合计算
- 支持历史数据快速检索

### 6. 用户目标表（user_goal）

**用户设定的使用目标**

```sql
CREATE TABLE user_goal (
    goal_id TEXT PRIMARY KEY,
    goal_type TEXT NOT NULL,
    target_value INTEGER NOT NULL,
    current_value INTEGER DEFAULT 0,
    period TEXT NOT NULL DEFAULT 'DAILY',
    is_active BOOLEAN DEFAULT TRUE,
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000),
    updated_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

CREATE INDEX idx_user_goal_type ON user_goal(goal_type);
CREATE INDEX idx_user_goal_active ON user_goal(is_active);
```

**字段详细说明：**

| 字段名 | SQL类型 | 约束 | 说明 |
|--------|---------|------|------|
| goal_id | TEXT | PRIMARY KEY | 目标唯一标识（UUID） |
| goal_type | TEXT | NOT NULL | 目标类型枚举值 |
| target_value | INTEGER | NOT NULL | 目标值（毫秒或次数） |
| current_value | INTEGER | DEFAULT 0 | 当前值（实时更新） |
| period | TEXT | DEFAULT 'DAILY' | 统计周期: DAILY/WEEKLY/MONTHLY |
| is_active | BOOLEAN | DEFAULT TRUE | 是否激活 |
| created_at | INTEGER | 自动设置 | 记录创建时间戳 |
| updated_at | INTEGER | 自动设置 | 记录更新时间戳 |

**索引设计：**
- idx_user_goal_type: 目标类型索引
- idx_user_goal_active: 激活状态索引

**业务规则：**
- `getProgressPercentage()`: 计算完成度百分比 = (current_value * 100) / target_value

### 7. 应用元数据表（app_metadata）

**缓存应用信息**

```sql
CREATE TABLE app_metadata (
    package_name TEXT PRIMARY KEY,
    app_name TEXT NOT NULL,
    category TEXT NOT NULL DEFAULT 'OTHER',
    icon_url TEXT,
    install_time INTEGER,
    is_system BOOLEAN DEFAULT FALSE,
    last_updated INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

CREATE INDEX idx_app_metadata_category ON app_metadata(category);
```

**字段详细说明：**

| 字段名 | SQL类型 | 约束 | 说明 |
|--------|---------|------|------|
| package_name | TEXT | PRIMARY KEY | 应用包名（唯一标识） |
| app_name | TEXT | NOT NULL | 应用显示名称 |
| category | TEXT | DEFAULT 'OTHER' | 应用分类枚举值 |
| icon_url | TEXT | 可为空 | 应用图标URL（本地或远程） |
| install_time | INTEGER | 可为空 | 应用安装时间戳 |
| is_system | BOOLEAN | DEFAULT FALSE | 是否为系统应用 |
| last_updated | INTEGER | 自动设置 | 元数据更新时间戳 |

**索引设计：**
- idx_app_metadata_category: 分类索引

**用途说明：**
- 缓存应用基本信息，减少系统查询
- 支持应用分类统计
- 识别系统应用和用户应用

---

## 🔍 查询示例

### 1. 今日四大核心指标查询

**查询1：今日APP打开次数**
```sql
-- 统计今日app_session表的记录条数
SELECT COUNT(*) 
FROM app_session 
WHERE date(start_time/1000, 'unixepoch') = date('now')
```
**说明**：每条记录代表一次APP切换到前台，直接统计记录数即可

**查询2：今日APP使用时长**
```sql
-- 汇总今日所有APP使用时长
SELECT COALESCE(SUM(duration), 0) 
FROM app_session 
WHERE date(start_time/1000, 'unixepoch') = date('now')
```
**说明**：包含所有记录（含duration=0），COALESCE处理无数据情况

**查询3：今日屏幕时长**
```sql
-- 统计SCREEN_ON事件的总时长
SELECT COALESCE(SUM(duration), 0) 
FROM screen_event 
WHERE event_type = 'SCREEN_ON' 
AND date(timestamp/1000, 'unixepoch') = date('now')
```
**说明**：需要通过SCREEN_ON/OFF事件配对计算，duration字段已预计算

**查询4：今日手机解锁次数**

```sql
-- 统计USER_PRESENT事件数量
SELECT COUNT(*) 
FROM screen_event 
WHERE event_type = 'USER_PRESENT' 
AND date(timestamp/1000, 'unixepoch') = date('now')
```
**说明**：每次解锁触发一次USER_PRESENT事件

### 2. 应用分类统计

**查询1：今日各分类使用统计**
```sql
-- 按分类汇总会话数和总时长
SELECT 
    category, 
    COUNT(*) as session_count,        -- 打开次数
    SUM(duration) as total_duration   -- 使用时长
FROM app_session 
WHERE date(start_time/1000, 'unixepoch') = date('now')
GROUP BY category
ORDER BY total_duration DESC
```
**结果示例**：
| category | session_count | total_duration |
|----------|--------------|----------------|
| 社交 | 45 | 7200000 (2小时) |
| 娱乐 | 23 | 5400000 (1.5小时) |
| 工具 | 18 | 1800000 (30分钟) |

**查询2：今日各分类打开次数排行**
```sql
-- 按打开次数排序
SELECT 
    category, 
    COUNT(*) as open_count
FROM app_session 
WHERE date(start_time/1000, 'unixepoch') = date('now')
GROUP BY category
ORDER BY open_count DESC
```

### 3. 最活跃应用统计

**查询1：今日最活跃应用（按时长排序）**
```sql
-- 统计每个APP的使用情况，按总时长排序
SELECT 
    package_name, 
    app_name, 
    category, 
    COUNT(*) as session_count,           -- 打开次数
    SUM(duration) as total_duration,     -- 总使用时长
    AVG(duration) as avg_duration        -- 平均单次时长
FROM app_session 
WHERE date(start_time/1000, 'unixepoch') = date('now')
GROUP BY package_name
ORDER BY total_duration DESC
LIMIT 10
```
**结果示例**：
| app_name | session_count | total_duration | avg_duration |
|----------|--------------|----------------|--------------|
| 微信 | 23 | 7200000 (2小时) | 313043 (5.2分钟) |
| 抖音 | 15 | 5400000 (1.5小时) | 360000 (6分钟) |

**查询2：今日最频繁打开应用（按次数排序）**
```sql
-- 按打开次数排序（不考虑时长）
SELECT 
    package_name, 
    app_name, 
    category, 
    COUNT(*) as open_count
FROM app_session 
WHERE date(start_time/1000, 'unixepoch') = date('now')
GROUP BY package_name
ORDER BY open_count DESC
LIMIT 10
```
**应用场景**：
- 查询1：查看哪些APP占用时间最多
- 查询2：查看哪些APP切换最频繁

---

## ⚠️ 数据一致性规则

### 1. 最小时长阈值处理

**原则：行为必须记录，时长可以过滤**

**处理逻辑**：
```mermaid
flowchart TD
    A[会话结束] --> B[计算实际时长<br/>actualDuration = endTime - startTime]
    B --> C{actualDuration < 1000ms?}
    C -->|是| D[设置 duration = 0]
    C -->|否| E[设置 duration = actualDuration]
    D --> F[保存会话记录]
    E --> F
    F --> G[记录参与打开次数统计]
```

**核心要点**：
1. **必须保存记录**：无论使用时长多短，都要保存到数据库
2. **时长可以为0**：< 1秒的会话，duration字段设为0
3. **统计仍然准确**：
   - APP打开次数 = COUNT(*) ✅ （包含所有记录）
   - APP使用时长 = SUM(duration) ✅ （自动过滤0时长）

### 2. 统计查询一致性

**统计方式对比**：

| 统计指标 | SQL查询 | 是否包含duration=0记录 | 说明 |
|---------|---------|---------------------|------|
| APP打开次数 | `COUNT(*)` | ✅ 包含 | 所有记录都计数 |
| APP使用时长 | `SUM(duration)` | ✅ 自动忽略 | SUM自动跳过0值 |

**查询示例**：

**方式1：包含所有记录（推荐）**
```sql
-- APP打开次数
SELECT COUNT(*) FROM app_session WHERE date = :date

-- APP使用时长（自动过滤0时长）
SELECT SUM(duration) FROM app_session WHERE date = :date
```

**方式2：显式过滤短时会话（可选）**
```sql
-- 只统计有效会话
SELECT SUM(duration) FROM app_session 
WHERE date = :date AND duration >= 1000
```

**推荐使用方式1**，因为：
- 打开次数统计更准确
- SUM会自动跳过duration=0的记录
- 查询逻辑更简单

---

## 🔧 数据库升级策略

### 从v1.0到v2.1的迁移

**数据库版本管理**：

| 版本号 | 包含实体 | 更新内容 |
|--------|---------|---------|
| v1 | usage_tracking | 旧版本（待废弃） |
| v2 | 基础表 | 初始化新表结构 |
| v3 | 7张核心表 | 完整v2.1架构 |

**核心实体清单**：
1. AppSession - 应用会话表
2. AppUsageDetail - 会话明细表
3. ScreenEvent - 屏幕事件表
4. NotificationEvent - 通知事件表
5. DailySummary - 每日汇总表
6. UserGoal - 用户目标表
7. AppMetadata - 应用元数据表

**迁移流程（v2 → v3）**：

```mermaid
flowchart TD
    A[开始迁移] --> B[1. 重命名旧表<br/>app_sessions → app_session_old]
    B --> C[2. 创建新表<br/>app_session with new schema]
    C --> D[3. 数据迁移<br/>处理字段变化]
    D --> E[4. 删除旧表]
    E --> F[5. 创建索引]
    F --> G[完成迁移]
```

**字段迁移映射**：
- session_id: 保持不变（若为空则生成UUID）
- open_count → switch_count (语义变更)
- 新增字段使用默认值

---

## 📚 相关文档

* [术语统一表 v2.1](./术语统一表.md) - 术语权威标准

* [核心指标定义说明](./核心指标定义说明.md) - 统计逻辑详细说明

* [技术说明_统计系统架构](./技术说明_统计系统架构.md) - 系统架构说明

* [前端UI设计方案 v2](./前端UI设计方案_v2.md) - UI设计规范

* [实现路线图 v2](./实现路线图_v2.md) - 开发计划

---

## 📝 版本历史

* **v2.1 (2025-10-15)**：

  * ✅ 统一表名为单数形式（app\_session等）

  * ✅ 删除openCount字段，改用COUNT(\*)统计

  * ✅ 新增switch\_count字段表示会话内切换次数

  * ✅ 明确最小时长阈值处理逻辑（<1秒设为0）

  * ✅ 与术语统一表v2.1完全同步

* **v2.0 (2025-10-14)**：

  * 初始版本，引入四大核心指标

  * 设计AppSession等新数据结构

* **v1.0 (旧版)**：

  * 使用复数表名和openCount字段

  * 术语定义不统一

